<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Drone Survey Estimator with Postcode Search</title>
<link rel="stylesheet" href="leaflet.css" />
<link rel="stylesheet" href="leaflet.draw.css" />
<!-- Mapbox GL CSS for 3D view -->
<link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" />
<style>
  body, html {
    height: 100%;
    margin: 0;
  }
  #map {
    height: calc(100vh - 50px);
    width: 100%;
  }
  .controls {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: #f7f7f7;
    border-bottom: 1px solid #ccc;
  }
  .controls input {
    padding: 4px 8px;
  }
  .controls button {
    padding: 5px 10px;
    cursor: pointer;
  }
  #message {
    color: red;
    font-size: 0.9em;
  }
</style>
</head>
<body>
<div class="controls">
  <input type="text" id="postcode-input" placeholder="Enter UK postcode" />
  <button id="postcode-search">Search</button>
  <span id="message"></span>
</div>
<div id="map"></div>
<script src="leaflet.js"></script>
<script src="leaflet.draw.js"></script>
<script src="turf.min.js"></script>
<!-- Mapbox GL JS and Leaflet plugin for 3D (only works if you provide a valid token below) -->
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
<script src="https://unpkg.com/mapbox-gl-leaflet@0.0.6/leaflet-mapbox-gl.js"></script>
<script>
  // Base layers
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  });
  const satellite = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19,
    attribution: 'Imagery &copy; Esri & contributors'
  });
  // Mapbox 3D layer (requires your own Mapbox access token). Replace ACCESS_TOKEN below.
  const mapbox3D = L.mapboxGL({
    accessToken: 'YOUR_MAPBOX_ACCESS_TOKEN',
    style: 'mapbox://styles/mapbox/satellite-streets-v12',
    interactive: true,
    pitch: 60,
    bearing: -60
  });

  // Initialize map
  const map = L.map('map', {
    center: [51.5074, -0.1278], // Default to London
    zoom: 12,
    layers: [osm]
  });

  // Layer control
  const baseLayers = {
    'Road Map': osm,
    'Satellite': satellite,
    '3D (requires token)': mapbox3D
  };
  L.control.layers(baseLayers).addTo(map);

  // Postcode search handler
  document.getElementById('postcode-search').addEventListener('click', function() {
    const postcode = document.getElementById('postcode-input').value.trim();
    const messageEl = document.getElementById('message');
    messageEl.textContent = '';
    if (!postcode) {
      messageEl.textContent = 'Please enter a postcode.';
      return;
    }
    // Use Nominatim to geocode UK postcode
    fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=gb&q=${encodeURIComponent(postcode)}`)
      .then(res => res.json())
      .then(data => {
        if (Array.isArray(data) && data.length > 0) {
          const { lat, lon, display_name } = data[0];
          const latNum = parseFloat(lat);
          const lonNum = parseFloat(lon);
          map.setView([latNum, lonNum], 18);
          L.marker([latNum, lonNum]).addTo(map).bindPopup(display_name).openPopup();
        } else {
          messageEl.textContent = 'Postcode not found.';
        }
      })
      .catch(err => {
        console.error(err);
        messageEl.textContent = 'Error searching postcode.';
      });
  });

  // Drawing layer group
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Draw control options
  const drawControl = new L.Control.Draw({
    edit: {
      featureGroup: drawnItems
    },
    draw: {
      polyline: false,
      circle: false,
      marker: false,
      circlemarker: false
    }
  });
  map.addControl(drawControl);

  // Calculate area using Turf.js
  function calculateArea(layer) {
    const geojson = layer.toGeoJSON();
    const area = turf.area(geojson); // in square metres
    return area;
  }

  map.on(L.Draw.Event.CREATED, function(e) {
    const layer = e.layer;
    drawnItems.addLayer(layer);
    const area = calculateArea(layer);
    const hectares = area / 10000;
    alert(`Area: ${hectares.toFixed(2)} hectares`);
  });
</script>
</body>
</html>
