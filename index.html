<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roof Inspection Tool Demo</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet">

  <style>
    html,body {height:100%;margin:0}
    #map {position:absolute;inset:0}
    .toolbar {
      position:absolute;left:12px;top:12px;display:flex;gap:8px;
      background:rgba(255,255,255,.92);border-radius:10px;padding:8px 10px;
      font:14px system-ui,sans-serif
    }
    .btn {border:0;background:#111;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
    .btn.alt {background:#e6e6e6;color:#111}
    .hud {
      position:absolute;left:12px;bottom:12px;background:rgba(255,255,255,.92);
      border-radius:10px;padding:10px 12px;font:14px/1.4 system-ui,sans-serif
    }
    .badge {display:inline-block;min-width:72px;text-align:right}

    /* navigation mode buttons */
    .nav-modes {
      position:absolute;left:12px;top:50%;transform:translateY(-50%);
      display:flex;flex-direction:column;gap:4px;
      background:rgba(255,255,255,.92);border-radius:10px;padding:8px;
    }
    .nav-modes button {
      width:32px;height:32px;display:flex;align-items:center;justify-content:center;
      border:0;border-radius:6px;background:transparent;color:#111;cursor:pointer;
      font-size:16px;line-height:1;transition:background .2s;
    }
    .nav-modes button.active {background:#111;color:#fff}
  </style>
</head>
<body>
  <div id="map" aria-label="Satellite map for drawing roofs"></div>

  <div class="toolbar" role="toolbar" aria-label="Drawing tools">
    <button id="draw-poly" class="btn" aria-pressed="true">Draw</button>
    <button id="trash" class="btn alt">Clear</button>
  </div>

  <div class="nav-modes" role="toolbar" aria-label="Navigation modes">
    <button aria-label="Orbit" data-mode="orbit" class="active">‚≠Æ</button>
    <button aria-label="Pan" data-mode="pan">‚úã</button>
    <button aria-label="Zoom" data-mode="zoom">üîç</button>
    <button aria-label="Fly" data-mode="fly">üïπ</button>
  </div>

  <div class="hud" role="status" aria-live="polite">
    <div>Area: <span class="badge" id="area-m2">0</span> m¬≤</div>
    <div>Area: <span class="badge" id="area-ft2">0</span> ft¬≤</div>
    <div>Est. cost: <span class="badge" id="estimate">‚Äì</span></div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicGRoMDQwNSIsImEiOiJjbWVvcHhyeWcwYmJpMm1xdmd0bXUzdDByIn0.6thOLX7aKDCd1POUgSPdSA';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/satellite-v9',
      center: [-2.0, 53.6],  // UK-ish
      zoom: 16,
      pitch: 45,
      bearing: -17
    });

    map.addControl(new mapboxgl.NavigationControl({ showZoom:true, showCompass:true }), 'top-right');

    const draw = new MapboxDraw({
      displayControlsDefault: false,
      controls: { polygon: true, trash: true },
      defaultMode: 'draw_polygon'
    });
    map.addControl(draw);

    const elM2 = document.getElementById('area-m2');
    const elFt2 = document.getElementById('area-ft2');
    const elEst = document.getElementById('estimate');

    function updateArea() {
      const data = draw.getAll();
      if (!data.features.length) {
        elM2.textContent = '0'; elFt2.textContent = '0'; elEst.textContent = '‚Äì'; return;
      }
      const areaM2 = turf.area(data);
      const areaFt2 = areaM2 * 10.76391041671;
      elM2.textContent = (Math.round(areaM2 * 100) / 100).toLocaleString();
      elFt2.textContent = (Math.round(areaFt2 * 100) / 100).toLocaleString();

      // Placeholder pricing (change later)
      const estimate = 49 + 0.45 * areaM2; // base + per m¬≤
      elEst.textContent = '¬£' + (Math.round(estimate * 100) / 100).toLocaleString();
    }

    map.on('draw.create', updateArea);
    map.on('draw.update', updateArea);
    map.on('draw.delete', updateArea);

    document.getElementById('draw-poly').addEventListener('click', () => draw.changeMode('draw_polygon'));
    document.getElementById('trash').addEventListener('click', () => { draw.deleteAll(); updateArea(); });

    // navigation modes
    const modeBar = document.querySelector('.nav-modes');
    let mode = 'orbit';
    modeBar.addEventListener('click', (e) => {
      if (e.target.matches('button')) {
        mode = e.target.dataset.mode;
        modeBar.querySelectorAll('button').forEach(b => b.classList.toggle('active', b === e.target));
        if (mode === 'fly') {
          map.setPitch(85);
        } else {
          map.setPitch(45);
        }
      }
    });

    map.getCanvas().addEventListener('contextmenu', e => e.preventDefault());

    let dragStart, startBearing, startPitch, startZoom;
    function startOrbit(e) {
      dragStart = [e.clientX, e.clientY];
      startBearing = map.getBearing();
      startPitch = map.getPitch();
      document.addEventListener('mousemove', onRotate);
      document.addEventListener('mouseup', endInteraction);
    }
    function onRotate(e) {
      const dx = e.clientX - dragStart[0];
      const dy = e.clientY - dragStart[1];
      map.setBearing(startBearing - dx * 0.4);
      map.setPitch(Math.max(0, Math.min(85, startPitch + dy * 0.4)));
    }

    function startPan(e) {
      dragStart = [e.clientX, e.clientY];
      document.addEventListener('mousemove', onPan);
      document.addEventListener('mouseup', endInteraction);
    }
    function onPan(e) {
      const dx = e.clientX - dragStart[0];
      const dy = e.clientY - dragStart[1];
      map.panBy([-dx, -dy], {animate:false});
      dragStart = [e.clientX, e.clientY];
    }

    function startDragZoom(e) {
      dragStart = e.clientY;
      startZoom = map.getZoom();
      document.addEventListener('mousemove', onDragZoom);
      document.addEventListener('mouseup', endInteraction);
    }
    function onDragZoom(e) {
      const dy = e.clientY - dragStart;
      map.zoomTo(startZoom - dy / 100, {animate:false});
    }

    function endInteraction() {
      document.removeEventListener('mousemove', onRotate);
      document.removeEventListener('mousemove', onPan);
      document.removeEventListener('mousemove', onDragZoom);
      document.removeEventListener('mouseup', endInteraction);
    }

    function onMouseDown(e) {
      if (mode === 'pan' || (e.altKey && e.button === 1)) {
        startPan(e);
      } else if (mode === 'zoom' || (e.altKey && e.button === 2)) {
        startDragZoom(e);
      } else if (mode === 'fly') {
        if (e.button === 0) startPan(e);
        if (e.button === 2) startOrbit(e);
      } else {
        // orbit default
        startOrbit(e);
      }
    }
    map.getCanvas().addEventListener('mousedown', onMouseDown);

    const keys = {};
    window.addEventListener('keydown', e => { keys[e.code] = true; });
    window.addEventListener('keyup', e => { keys[e.code] = false; });
    function flyLoop() {
      if (mode === 'fly') {
        const step = 10;
        let off = [0,0];
        if (keys['KeyW']) off[1] -= step;
        if (keys['KeyS']) off[1] += step;
        if (keys['KeyA']) off[0] -= step;
        if (keys['KeyD']) off[0] += step;
        if (off[0] || off[1]) map.panBy(off, {animate:false});
      }
      requestAnimationFrame(flyLoop);
    }
    flyLoop();

    map.on('dblclick', e => {
      e.preventDefault();
      map.flyTo({center: e.lngLat});
    });

    window.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 'f') {
        const data = draw.getAll();
        if (data.features.length) {
          const box = turf.bbox(data);
          map.fitBounds([[box[0], box[1]], [box[2], box[3]]], {padding:40});
        }
      }
    });
  </script>
</body>
</html>
